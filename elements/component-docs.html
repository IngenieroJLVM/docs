<!--
    @license
    Copyright (c) 2014 The Polymer Project Authors. All rights reserved.
    This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
    The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
    The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
    Code distributed by Google as part of the polymer project is also
    subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->
<link rel="import" href="../components/polymer/polymer.html">
<link rel="import" href="../components/context-free-parser/context-free-parser.html">
<link rel="import" href="doc-page.html">

<polymer-element name="component-docs" attributes="bannerHeight elements">
  <template>
    <context-free-parser url="{{url}}" data="{{data}}" on-data-ready="{{dataReady}}">
    </context-free-parser>
    <template repeat="{{c in data.classes}}">
      <doc-page id="{{c.name}}" name="{{c.name}}" data="{{c}}"
                bannerHeight="{{bannerHeight}}"
                downloadable?="{{ isTopLevelElement(c.name, url) }}"></doc-page>
    </template>
  </template>
  <script>
    Polymer('component-docs', {
      // Default to the height of the banner on the current site, though this can
      // be overridden by the page that uses <compontent-docs> as needed.
      bannerHeight: 80,
      elementName: null,
      url: null,
      elements: {},
      updateElementFromHash: function(e) {
        // The URL fragment might be just an element name,
        // or it might be an element name followed by a '.' and then
        // a section of the page.
        // We want to match on just element names here, so split on '.'.
        // E.g.: 'core-ajax.properties.xhrArgs' -> 'core-ajax'
        //       'core-xhr' -> 'core-xhr'
        var elementName = window.location.hash.slice(1).split('.')[0];
        if (this.elementName !== elementName && this.elements[elementName]) {
          this.elementName = elementName;
          document.body.classList.add('hide-on-hash'); // Hide on .hide-on-hash elements.
        }
      },
      domReady: function() {
        this.updateElementFromHash();
        window.addEventListener('hashchange', this.updateElementFromHash.bind(this));
      },
      detached: function() {
        document.body.classList.remove('hide-on-hash');
        window.removeEventListener('hashchange', this.updateElementFromHash.bind(this));
      },
      elementNameChanged: function() {
        this.url = '/' + this.elements[this.elementName];
        // Only update the location.hash here if the name of the new element
        // isn't already at the start of the hash (position 1, after the '#').
        // This will ensure that we don't overwrite a hash like
        // #<elementName>.something.something with #<elementName>
        if (window.location.hash.indexOf(this.elementName) !== 1) {
          window.location.hash = this.elementName;
        }
      },
      dataChanged: function() {
        if (this.data.classes[0].name === 'Entity') {
          this.data.classes[0].name = this.elementName;
        }
      },
      isTopLevelElement: function(name, url) {
        return url.indexOf('/components/' + name + '/') == 0;
      }
    });
  </script>
</polymer-element>
